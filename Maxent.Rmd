---
title: "Maximum tree height in the Amazon"
output: html_notebook
---

## Introduction

Análise Random Forest para avaliar fatores ambientais que influenciam na distribuição das alturas emergentes.

## Material and Methods

```{r, message=FALSE}
require(ggplot2)
require(raster)
require(tidyverse)
require(tmap)
require(sf)
require(leaflet)
require(sp)
require(gridExtra)
require(magrittr)
require(factoextra) 
require(randomForest)
require(caret)
require(maptools)
require(dismo)
library(rgdal)
library(maps)
library(mapdata)
library(dismo)  
#library(rJava)  
library(jsonlite)

# 
Sys.setenv(JAVA_HOME='C:\\Program Files\\Java\\jre1.8.0_241')
```

### Maximum height dataset

Transects and maximum height extraction....

```{r, message=FALSE}
amaz = shapefile('./data/amazbioma.shp')
maximas = sf::as_Spatial(st_read(dsn = './data/maximum height 200222.gpkg', layer = 'pontos_wgs84'))
maximas@data = maximas@data %>% select(3)
tm_shape(amaz) + tm_polygons() + 
  tm_shape(maximas) + tm_dots("altura_cop", size = 0.2, palette = "RdYlGn")
```

### Wind speed

```{r}
uspeed = raster('./data/uspeed.tif')
uspeed = setMinMax(uspeed)
ref = uspeed

#tm_shape(uspeed) + tm_raster(n = 10)
```

```{r}
vspeed = raster('./data/vspeed.tif') %>% crop(ref)
vspeed = raster(vals=values(vspeed),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
vspeed = setMinMax(vspeed)

#tm_shape(vspeed) + tm_raster(n = 10)
```

### Elevation and freatic access

```{r}
srtm = raster('./data/srtm.tif') %>% crop(ref)
srtm = raster(vals=values(srtm),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])

srtm[srtm <= 0] = NA
srtm[srtm >= 1000] = NA
srtm = setMinMax(srtm)

#tm_shape(srtm) + tm_raster(n = 10)

```



### Radiation

```{r}
clearDays = raster('./data/clearDays.tif') %>% crop(ref)
clearDays = raster(vals=values(clearDays),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
clearDays = setMinMax(clearDays)

#tm_shape(clearDays) + tm_raster(n = 10)
```

```{r}
fapar = raster('./data/fapar.tif') %>% crop(ref)
fapar = raster(vals=values(fapar),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
fapar = setMinMax(fapar)

#tm_shape(fapar) + tm_raster(n = 10)
```


```{r}
pet = raster('./data/pet.tif') %>% crop(ref)
pet = raster(vals=values(pet),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pet = setMinMax(pet)

#tm_shape(pet) + tm_raster(n = 10)
```

### Precipitation

```{r}
days20 = raster('./data/days20.tif') %>% crop(ref)
days20 = raster(vals=values(days20),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
days20 = setMinMax(days20)

#tm_shape(days20) + tm_raster(n = 10)
```


```{r}
month100 = raster('./data/month100.tif') %>% crop(ref)
month100 = raster(vals=values(month100),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
month100 = setMinMax(month100)

#tm_shape(month100) + tm_raster(n = 10)
```


```{r}
pannual = raster('./data/pannual.tif') %>% crop(ref)
pannual = raster(vals=values(pannual),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pannual = setMinMax(pannual)

#tm_shape(pannual) + tm_raster(n = 10)
```


```{r}
pdriest = raster('./data/pdriest.tif') %>% crop(ref)
pdriest = raster(vals=values(pdriest),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pdriest = setMinMax(pdriest)

#tm_shape(pdriest) + tm_raster(n = 10)
```


```{r}
pwettest = raster('./data/pwettest.tif') %>% crop(ref)
pwettest = raster(vals=values(pwettest),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pwettest = setMinMax(pwettest)

#tm_shape(pwettest) + tm_raster(n = 10)
```


```{r}
pseason = raster('./data/pseason.tif') %>% crop(ref)
pseason = raster(vals=values(pseason),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pseason = setMinMax(pseason)

#tm_shape(pseason) + tm_raster(n = 10)
```


### Temperature

```{r}
tseason = raster('./data/tseason.tif') %>% crop(ref)
tseason = raster(vals=values(tseason),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
tseason = setMinMax(tseason)

#tm_shape(tseason) + tm_raster(n = 10)
```


```{r}
tannual = raster('./data/tannual.tif') %>% crop(ref)
tannual = raster(vals=values(tannual),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
tannual = setMinMax(tannual)

#tm_shape(tannual) + tm_raster(n = 10)
```


```{r}
tmax = raster('./data/tmax.tif') %>% crop(ref)
tmax = raster(vals=values(tmax),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
tmax = setMinMax(tmax)

#tm_shape(tmax) + tm_raster(n = 10)
```


### Storms

```{r}
lightning = raster('./data/lightning.tif') %>% crop(ref)
lightning = raster(vals=values(lightning),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
lightning = setMinMax(lightning)

#tm_shape(lightning) + tm_raster(n = 10)
```


### Clay content

```{r}
claycontent = raster('./data/clayContent30m.tif') %>% crop(ref)
claycontent = raster(vals=values(claycontent),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
claycontent = setMinMax(claycontent)

#tm_shape(claycontent) + tm_raster(n = 10)
```

# Water Content in soil 

```{r}

waterContent = raster('./data/waterContent30m.tif') %>% crop(ref)
waterContent = raster(vals=values(waterContent),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
waterContent30m = setMinMax(waterContent)

#tm_shape(waterContent) + tm_raster(n = 10)
```


## Results

### Maximum tree height distribution

```{r}
taller50 = maximas[maximas$altura_cop > 50,]
tm_shape(amaz) + 
        tm_polygons(col="grey", border.col="white") +
        tm_shape(taller50) + tm_dots("red", size=.2) +
        tm_grid(labels.inside.frame = FALSE, 
                projection = "+proj=longlat", col = 'gray')
#rm(taller50)
```

```{r}
taller60 = maximas[maximas$altura_cop > 60,]
tm_shape(amaz) + 
        tm_polygons(col="grey", border.col="white") +
        tm_shape(taller60) + tm_dots("red", size=.2) +
        tm_grid(labels.inside.frame = FALSE, 
                projection = "+proj=longlat", col = 'gray')
#rm(taller60)
```

```{r}
taller70 = maximas[maximas$altura_cop > 70,]
tm_shape(amaz) + 
        tm_polygons(col="grey", border.col="white") +
        tm_shape(taller70) + tm_dots("red", size=.2) +
        tm_grid(labels.inside.frame = FALSE, 
                projection = "+proj=longlat", col = 'gray')
rm(taller70)
```

```{r}
taller80 = maximas[maximas$altura_cop > 80,]
tm_shape(amaz) + 
        tm_polygons(col="grey", border.col="white") +
        tm_shape(taller80) + tm_dots("red", size=.2) +
        tm_grid(labels.inside.frame = FALSE, 
                projection = "+proj=longlat", col = 'gray')
rm(taller80)
```

### Varible importance

Clip environmental variables matching maximum height location...

```{r}
# cria stack das variáveis ambientais
layers = stack(srtm, uspeed, vspeed, clearDays, days20, fapar, lightning, month100, pannual, pdriest, pet, 
pseason, pwettest, tannual, tseason,claycontent,waterContent)

# Nomeação das variáveis
names(layers) = c("srtm", "uspeed", "vspeed", "clearDays", "days20", "fapar", "lightning", "month100", "pannual", "pdriest", "pet", 
"pseason", "pwettest", "tannual", "tseason","claycontent","waterContent")
modelEnv<-layers

# Alturas com limites estabelecidos (>50m, >60m, >70m e >75m)
maximas_50<-maximas[maximas$altura_cop>50,]
maximas_60<-maximas[maximas$altura_cop>60,]
maximas_70<-maximas[maximas$altura_cop>70,]
maximas_75<-maximas[maximas$altura_cop>75,]
View(maximas)
```

```{r}

# Coordenadas para a extensão de corte do mapa
model.extent<-extent(min(maximas_50$coords.x1)-10,max(maximas_50$coords.x1)+10,min(maximas_50$coords.x2)-10,max(maximas_50$coords.x2)+10)


# data frame com latitude e longitude
rattlerocc=data.frame(x1=maximas_50[,2],x2=maximas_50[,3]) #first, just make a data frame of latitudes and longitudes for the model


fold <- kfold(rattlerocc, k=5) # add an index that makes five random groups of observations

oco_teste <- rattlerocc[fold == 1, ] # hold out one fifth as test data
oco_treino <- rattlerocc[fold != 1, ] # the other four fifths are training data


rattler.me <- maxent(modelEnv, oco_treino) #note we just using the training data

plot(rattler.me)
response(rattler.me)


modelo_50m <- predict(rattler.me, modelEnv)

plot(modelo_50m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_50$coords.x1, maximas_50$coords.x2, pch="+", cex=1)


```

# Tree >60 m
```{r}

# data frame com latitude e longitude
rattlerocc=data.frame(x1=maximas_60[,2],x2=maximas_60[,3]) #first, just make a data frame of latitudes and longitudes for the model


fold <- kfold(rattlerocc, k=5) # add an index that makes five random groups of observations

oco_teste <- rattlerocc[fold == 1, ] # hold out one fifth as test data
oco_treino <- rattlerocc[fold != 1, ] # the other four fifths are training data


rattler.me <- maxent(modelEnv, rattlertrain) #note we just using the training data

plot(rattler.me)
response(rattler.me)


modelo_60m <- predict(rattler.me, modelEnv)

plot(modelo_60m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_60$coords.x1, maximas_60$coords.x2, pch="+", cex=1)


```

# Tree >70 m
```{r}

# data frame com latitude e longitude
rattlerocc=data.frame(x1=maximas_70[,2],x2=maximas_70[,3]) #first, just make a data frame of latitudes and longitudes for the model


fold <- kfold(rattlerocc, k=5) # add an index that makes five random groups of observations

oco_teste <- rattlerocc[fold == 1, ] # hold out one fifth as test data
oco_treino <- rattlerocc[fold != 1, ] # the other four fifths are training data


rattler.me <- maxent(modelEnv, oco_treino) #note we just using the training data

plot(rattler.me)
response(rattler.me)


modelo_70m <- predict(rattler.me, modelEnv)

plot(modelo_70m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_70$coords.x1, maximas_70$coords.x2, pch="+", cex=1)


```

# Tree >75 m
```{r}

# data frame com latitude e longitude
rattlerocc=data.frame(x1=maximas_75[,2],x2=maximas_75[,3]) #first, just make a data frame of latitudes and longitudes for the model


fold <- kfold(rattlerocc, k=5) # add an index that makes five random groups of observations

oco_teste <- rattlerocc[fold == 1, ] # hold out one fifth as test data
oco_treino <- rattlerocc[fold != 1, ] # the other four fifths are training data


rattler.me <- maxent(modelEnv, oco_treino) #note we just using the training data

plot(rattler.me)
response(rattler.me)


modelo_75m <- predict(rattler.me, modelEnv)

plot(modelo_75m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_75$coords.x1, maximas_75$coords.x2, pch="+", cex=1)


```

```{r}
par(mfrow=c(1,4))
plot(modelo_50m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_50$coords.x1, maximas_50$coords.x2, pch="+", cex=1)

plot(modelo_60m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_60$coords.x1, maximas_60$coords.x2, pch="+", cex=1)

plot(modelo_70m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_70$coords.x1, maximas_70$coords.x2, pch="+", cex=1)

m<-plot(modelo_75m, main="Predicted Suitability")
map('worldHires', fill=FALSE, add=TRUE)
points(maximas_75$coords.x1, maximas_75$coords.x2, pch="+", cex=1)
m
```

