---
title: "Maximum tree height in the Amazon"
output: html_notebook
---

```{r, message=FALSE}
require(ggplot2)
require(raster)
require(tidyverse)
require(tmap)
require(sf)
require(leaflet)
require(sp)
require(gridExtra)
require(magrittr)
require(factoextra) 
require(randomForest)
require(caret)
```

### Maximum height dataset

Transects and maximum height extraction....

```{r, message=FALSE}
amaz = shapefile('./data/amazbioma.shp')
maximas = sf::as_Spatial(st_read(dsn = './data/maximum height 200222.gpkg', layer = 'pontos_wgs84'))
maximas@data = maximas@data %>% select(3)
tm_shape(amaz) + tm_polygons() + 
  tm_shape(maximas) + tm_dots("altura_cop", size = 0.2, palette = "RdYlGn")
```

### Wind speed

```{r}
uspeed = raster('./data/uspeed.tif')
uspeed = setMinMax(uspeed)
ref = uspeed

#tm_shape(uspeed) + tm_raster(n = 10)
```


```{r}
vspeed = raster('./data/vspeed.tif') %>% crop(ref)
vspeed = raster(vals=values(vspeed),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
vspeed = setMinMax(vspeed)

#tm_shape(vspeed) + tm_raster(n = 10)
```


### Elevation and freatic access

```{r}
srtm = raster('./data/srtm.tif') %>% crop(ref)
srtm = raster(vals=values(srtm),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])

srtm[srtm <= 0] = NA
srtm[srtm >= 1000] = NA
srtm = setMinMax(srtm)

#tm_shape(srtm) + tm_raster(n = 10)

```

### Water balance

```{r}
pet = raster('./data/pet.tif') %>% crop(ref)
pet = raster(vals=values(pet),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pet = setMinMax(pet)

#tm_shape(pet) + tm_raster(n = 10)
```

### Radiation

```{r}
fapar = raster('./data/fapar.tif') %>% crop(ref)
fapar = raster(vals=values(fapar),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
fapar = setMinMax(fapar)

#tm_shape(fapar) + tm_raster(n = 10)
```


```{r}
clearDays = raster('./data/clearDays.tif') %>% crop(ref)
clearDays = raster(vals=values(clearDays),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
clearDays = setMinMax(clearDays)

#tm_shape(clearDays) + tm_raster(n = 10)
```

### Precipitation

```{r}
days20 = raster('./data/days20.tif') %>% crop(ref)
days20 = raster(vals=values(days20),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
days20 = setMinMax(days20)

#tm_shape(days20) + tm_raster(n = 10)
```

```{r}
month100 = raster('./data/month100.tif') %>% crop(ref)
month100 = raster(vals=values(month100),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
month100 = setMinMax(month100)

#tm_shape(month100) + tm_raster(n = 10)
```

```{r}
pannual = raster('./data/pannual.tif') %>% crop(ref)
pannual = raster(vals=values(pannual),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pannual = setMinMax(pannual)

#tm_shape(pannual) + tm_raster(n = 10)
```

```{r}
pdriest = raster('./data/pdriest.tif') %>% crop(ref)
pdriest = raster(vals=values(pdriest),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pdriest = setMinMax(pdriest)

#tm_shape(pdriest) + tm_raster(n = 10)
```


```{r}
pwettest = raster('./data/pwettest.tif') %>% crop(ref)
pwettest = raster(vals=values(pwettest),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pwettest = setMinMax(pwettest)

#tm_shape(pwettest) + tm_raster(n = 10)
```

```{r}
pseason = raster('./data/pseason.tif') %>% crop(ref)
pseason = raster(vals=values(pseason),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
pseason = setMinMax(pseason)

#tm_shape(pseason) + tm_raster(n = 10)
```

### Temperature

```{r}
tseason = raster('./data/tseason.tif') %>% crop(ref)
tseason = raster(vals=values(tseason),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
tseason = setMinMax(tseason)

#tm_shape(tseason) + tm_raster(n = 10)
```


```{r}
tannual = raster('./data/tannual.tif') %>% crop(ref)
tannual = raster(vals=values(tannual),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
tannual = setMinMax(tannual)

#tm_shape(tannual) + tm_raster(n = 10)
```


```{r}
tmax = raster('./data/tmax.tif') %>% crop(ref)
tmax = raster(vals=values(tmax),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
tmax = setMinMax(tmax)

#tm_shape(tmax) + tm_raster(n = 10)
```

### Storms

```{r}
lightning = raster('./data/lightning.tif') %>% crop(ref)
lightning = raster(vals=values(lightning),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
lightning = setMinMax(lightning)

#tm_shape(lightning) + tm_raster(n = 10)
```

### Soil information

```{r}
clayContent = raster('./data/clayContent30m.tif') %>% crop(ref)
clayContent = raster(vals=values(clayContent),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
clayContent = setMinMax(clayContent)

#tm_shape(clayContent) + tm_raster(n = 10)
```

```{r}
waterContent = raster('./data/waterContent30m.tif') %>% crop(ref)
waterContent = raster(vals=values(waterContent),
              ext=extent(ref), 
              nrows=dim(ref)[1],
              ncols=dim(ref)[2])
waterContent = setMinMax(waterContent)

#tm_shape(waterContent) + tm_raster(n = 10)
```

## Results

### Varible importance

Clip environmental variables matching maximum height location...

```{r}
# cria stack das variáveis ambientais
layers = stack(srtm, uspeed, vspeed, clearDays, days20, fapar, lightning, month100, pannual, pdriest, pdsi, pet, pseason, pwettest, tannual, tseason, clayContent, waterContent)

# atualiza nome das camadas
names(layers) = c("srtm", "uspeed", "vspeed", "clearDays", "days20", "fapar", "lightning", "month100", "pannual", "pdriest", "pdsi", "pet", "pseason", "pwettest", "tannual", "tseason", "clayContent", "waterContent")

# extrai valor das variáveis ambientais para cada altura máxima mapeada
explanatoryVariables = extract(layers, maximas)
# exclui o stack de camadas originais
rm(layers)

# adiciona no shapefile das alturas máximas os valores das variáveis ambientais extraídas
maximas@data = cbind(maximas@data, explanatoryVariables)
# exclui dataframe das variáveis ambientais temporária
rm(explanatoryVariables)

# explora graficamente a associação entre altura maxima e variáveis ambientais
#plot(maximas@data)
```


```{r}
# separa as variáveis explicativas
input = maximas@data %>% na.omit() %>% select(-altura_cop)
# separa a variável altura maxima
output = maximas@data %>% na.omit() %>% select(altura_cop)
# renomeia a variável
names(output) = c("height")
# normaliza as variáveis explicativas
inputScaled = input %>% preProcess(method = c("center", "scale")) %>% predict(input)
# salvar parâmetros da normalização
normParam = preProcess(input, method = c("center", "scale"))
```


```{r}
# cria base com variável dependente original com independente normalizada
driversScaled = cbind(output, inputScaled)
# limpa variáveis que não serão mais utilizadas
rm(output, input, inputScaled)
# divide os trasectos em k-folds
folds = driversScaled %>% row.names() %>% groupKFold(k = 15)           

# parametriza os parametros de controle da função train do pacote caret
group_fit_control = trainControl(index = folds, method = "cv")     
# define variáveis dependentes e independentes
res.rf = train(height ~ .,                                         
               data = driversScaled, # define base de dados                  
               method='rf',          # define modelo a ser treinado
               importance=T,         # análise de importancia para as variaveis
               trControl = group_fit_control) # parâmetros para validação cruzada

# limpa da memória parâmetros para Random Forest
rm(folds, group_fit_control)

# apresenta importância das variáveis com base nos modelos Random Forest
varImp(res.rf)
```

Normaliza raster para serem input para o modelo ajustado....

```{r}
# normaliza camada uspeed
uspeedScaled = (uspeed - normParam$mean['uspeed']) / normParam$std['uspeed']
# remove raster original uspeed
rm(uspeed)

# normaliza camada vspeed
vspeedScaled = (vspeed - normParam$mean['vspeed']) / normParam$std['vspeed']
# remove raster original uspeed
rm(vspeed)

# normaliza camada uspeed
srtmScaled = (srtm - normParam$mean['srtm']) / normParam$std['srtm']
# remove raster original uspeed
rm(srtm)

scaledLayers = stack(srtmScaled, uspeedScaled, vspeedScaled)
names(scaledLayers) = c("srtm", "uspeed", "vspeed")
rm(srtmScaled, uspeedScaled, vspeedScaled)

```

Aplica Random Forest para stack normalizado...

```{r}

heightRaster = predict(scaledLayers, res.rf)
heightRaster = setMinMax(heightRaster)

tm_shape(heightRaster) + tm_raster()
```

